<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="">
<meta name="dcterms.date" content="2024-02-10">
<meta name="description" content="A Probabilistic approach to AML Detection">

<title>Base Rate Neglect in AML</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-d166b450ba5a8e9f7a0ab969bf6592c1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-22381ab97ffb8a420d3841344730e94d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Base Rate Neglect in AML</h1>
                  <div>
        <div class="description">
          A Probabilistic approach to AML Detection
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Article</div>
                <div class="quarto-category">Anti Money Laundering</div>
                <div class="quarto-category">Probability</div>
                <div class="quarto-category">R</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 10, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-medical-test-paradox-1" id="toc-the-medical-test-paradox-1" class="nav-link active" data-scroll-target="#the-medical-test-paradox-1">The Medical Test Paradox </a>
  <ul class="collapse">
  <li><a href="#posterior-odds-with-bayes-factors" id="toc-posterior-odds-with-bayes-factors" class="nav-link" data-scroll-target="#posterior-odds-with-bayes-factors">Posterior Odds with Bayes Factors</a></li>
  </ul></li>
  <li><a href="#the-prosecutors-fallacy" id="toc-the-prosecutors-fallacy" class="nav-link" data-scroll-target="#the-prosecutors-fallacy">The Prosecutorâ€™s Fallacy</a></li>
  <li><a href="#why-this-matters-in-aml" id="toc-why-this-matters-in-aml" class="nav-link" data-scroll-target="#why-this-matters-in-aml">Why this matters in AML</a>
  <ul class="collapse">
  <li><a href="#fi-1-under-regime-1" id="toc-fi-1-under-regime-1" class="nav-link" data-scroll-target="#fi-1-under-regime-1">FI 1 under regime 1</a></li>
  <li><a href="#fi-2-under-regime-1" id="toc-fi-2-under-regime-1" class="nav-link" data-scroll-target="#fi-2-under-regime-1">FI 2 under regime 1</a></li>
  <li><a href="#fi-1-under-regime-2" id="toc-fi-1-under-regime-2" class="nav-link" data-scroll-target="#fi-1-under-regime-2">FI 1 under regime 2</a></li>
  <li><a href="#fi-2-under-regime-2" id="toc-fi-2-under-regime-2" class="nav-link" data-scroll-target="#fi-2-under-regime-2">FI 2 under regime 2</a></li>
  </ul></li>
  <li><a href="#takeaways" id="toc-takeaways" class="nav-link" data-scroll-target="#takeaways">Takeaways</a></li>
  <li><a href="#references-and-resources" id="toc-references-and-resources" class="nav-link" data-scroll-target="#references-and-resources">References and Resources</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>For decades, false positives have plagued Anti Money Laundering (AML) detection efforts, creating an industry-wide challenge. Stories abound of Investigation teams creaking under the ever increasing burden of noisy alerts. Addressing this ever growing volume of alerts is an industry unto itself.</p>
<p>In this post, I will argue that the problem may not be with the alerts or detection system itself but how we interpret what they mean and our failure to view them them through the right lens of probability.</p>
<p>One of the classic examples that highlight our inability to assess probabilities accurately is the medical test paradox.(see footnote for 3B1Bâ€™s excellent video)</p>
<section id="the-medical-test-paradox-1" class="level2">
<h2 class="anchored" data-anchor-id="the-medical-test-paradox-1">The Medical Test Paradox <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></h2>
<p>Assume that you take a medical test with a sensitivity of 0.99 and a specificity of 0.9 . If the test comes back as positive, what is the probability you have the disease ?</p>
<p><strong>Sensitivity</strong> or <strong>True Positive rate</strong> is the likelihood that the medical test (T) will return a positive result (+) if a patient has the disease(D).</p>
<p><span class="math display">\[ P(T = + \mid D) = 0.99 \]</span> <strong>Specificity</strong> or <strong>True Negative Rate</strong> is the likelihood that the test will return a negative result if a patient does not have a disease.</p>
<p><span class="math display">\[ P(T = - \mid \neg D) = 0.9 \]</span></p>
<p>The complement of the True Negative Rate or Specificity is the False Positive rate.</p>
<p><span class="math display">\[  P(T = +  \mid \neg D) = 1 - P(T = - \mid \neg D) = 1 - 0.9 = 0.1 \]</span> The True Positive Rate and False Positive Rates represent <strong>Sampling probabilities</strong>. Given a hypothesis or condition (e.g.&nbsp;the patient has a disease), it tells us how likely we are to observe a specific outcome (e.g.&nbsp;medical test is positive ).</p>
<p>The value we need to compute is <span class="math inline">\(P(\frac{D}{T = +})\)</span> . This is also known as the Positive Predictive Value. This is an <strong>Inferential Probability</strong>. Given an observation (medical test is positive), it tells how likely a hypothesis (patient has the disease) is.</p>
<p>This just requires a simple application of Bayes rule.</p>
<p><span class="math display">\[ P(D \mid T = +) =  \frac {P(T = + \mid D) \times P(D)}{P(T = +)}  \]</span></p>
<p>Note the denominator in the above expression simply evaluates the total probability of the test being positive which is give by.</p>
<p><span class="math display">\[ P(T = +) =  P(T = + \mid D) \times P(D) + P(T = + \mid \neg D) \times P( \neg D) \]</span></p>
<p>This simply accounts for the probability that the test can be positive when the patient has the disease or is free of the disease.</p>
<p>Note also that <span class="math inline">\(P(T = + \mid \neg D) = 1 - P(T = - \mid \neg D)\)</span>. We already know the value of the latter term (True Negative Rate).</p>
<p>We already have most of the values we need to compute the required probability. Plugging them below, we get</p>
<p><span class="math display">\[ P(D \mid T = +) =  \frac { 0.99 \times P(D)}{ 0.99 \times P(D) + ( 1- 0.9) \times P( \neg D)}  \]</span></p>
<p>This leaves us with two terms we need to determine. <span class="math inline">\(P(D)\)</span> is the prior probability you will assign to someone having a disease.</p>
<p>Now if this is an extremely rare disease or if you are looking at a patient who is very unlikely to have this disease based on medical history or other demographic and socio-economic factors, you would assign a low prior probability.</p>
<p>For example, the prior for Bob having Covid when he has been sheltering in place for the last 1 month is really low. Say <span class="math inline">\(P(D) = 0.01\)</span>.</p>
<p>On the other hand, Alice has been travelling for the last month without wearing a mask, the prior for Alice would be quite high. Say <span class="math inline">\(P(D) = 0.25\)</span></p>
<p>With this information, we can calculate the posterior probability that a patient has the disease given a positive test.</p>
<p>This simple function implements the above formula.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>posterior_prob <span class="ot">&lt;-</span> <span class="cf">function</span>(prior,sensitivity,specificity){</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  post <span class="ot">&lt;-</span> (sensitivity <span class="sc">*</span> prior)<span class="sc">/</span>(sensitivity<span class="sc">*</span>prior <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span> specificity)<span class="sc">*</span>(<span class="dv">1</span> <span class="sc">-</span> prior))</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(post)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Probability of Bob having Covid is:"</span>,<span class="fu">round</span>(<span class="fu">posterior_prob</span>(<span class="fl">0.01</span>,<span class="fl">0.99</span>,<span class="fl">0.9</span>),<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## Probability of Bob having Covid is: 0.09</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Probability of Alice having Covid is:"</span>,<span class="fu">round</span>(<span class="fu">posterior_prob</span>(<span class="fl">0.25</span>,<span class="fl">0.99</span>,<span class="fl">0.9</span>),<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## Probability of Alice having Covid is: 0.77</code></pre>
<p>As you can see, even though the medical test has an ostensibly high accuracy,the likelihood that a patient testing positive has Covid is not nearly as high as one would expect.The priors also make a significant difference to the eventual diagnosis.</p>
<p>I contend that AML models and scenarios are equivalent to medical tests. Just as medical tests tell us whether a patient has a disease, an AML model is supposed to tell us whether a customer is a money launderer by creating an alert or a case. Just as with medical tests, how we interpret the alert or case is important.</p>
<section id="posterior-odds-with-bayes-factors" class="level3">
<h3 class="anchored" data-anchor-id="posterior-odds-with-bayes-factors">Posterior Odds with Bayes Factors</h3>
<p>An equivalent and perhaps more intuitive way of solving this problem is with odds rather than probabilities.To do this</p>
<ol type="1">
<li>Express the prior as odds. Given a probability <span class="math inline">\(p\)</span>, the odds are given by <span class="math inline">\(\frac{p}{1-p}\)</span></li>
</ol>
<div class="sourceCode" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>prob_to_odds <span class="ot">&lt;-</span> <span class="cf">function</span>(p) p<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For Bob, the prior odds would be <span class="math inline">\(\frac{0.01}{0.99}\)</span>.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prob_to_odds</span>(<span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## [1] 0.01010101</code></pre>
<p>For Alice, this would be <span class="math inline">\(\frac{0.25}{0.75}\)</span></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prob_to_odds</span>(<span class="fl">0.25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## [1] 0.3333333</code></pre>
<ol start="2" type="1">
<li>Calculate the Bayes Factor.</li>
</ol>
<p>This is the ratio of the sensitivity(TPR) of the test to the FPR. <span class="math display">\[ BF = \frac{Sensitivity}{FPR} =  \frac{P(T = + \mid D)}{P(T = + \mid \neg D)}  \]</span> The simple function below computes the Bayes Factor.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>bf<span class="ot">&lt;-</span> <span class="cf">function</span>(sensitivity,specificity){</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(sensitivity<span class="sc">/</span>(<span class="dv">1</span> <span class="sc">-</span> specificity))</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The BF for the test in question is given by</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">bf</span>(<span class="fl">0.99</span>,<span class="fl">0.9</span>),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## [1] 9.9</code></pre>
<ol start="3" type="1">
<li>Calculate the posterior odds by multiplying the prior odds with the Bayes Factor.</li>
</ol>
<div class="sourceCode" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">" The odds of Bob having Covid is:"</span>,<span class="fu">round</span>(<span class="fu">prob_to_odds</span>(<span class="fl">0.01</span>)<span class="sc">*</span><span class="fu">bf</span>(<span class="fl">0.99</span>,<span class="fl">0.9</span>),<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>##  The odds of Bob having Covid is: 0.1</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">" The odds of Alice having Covid is:"</span>,<span class="fu">round</span>(<span class="fu">prob_to_odds</span>(<span class="fl">0.25</span>)<span class="sc">*</span><span class="fu">bf</span>(<span class="fl">0.99</span>,<span class="fl">0.9</span>),<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>##  The odds of Alice having Covid is: 3.3</code></pre>
<p>Given odds of <span class="math inline">\(o\)</span>, the probability <span class="math inline">\(p\)</span> is given by <span class="math inline">\(\frac{o}{1+o}\)</span>.</p>
<p>We can confirm the odds compute here are same as the probabilities computed above.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>odds_to_prob <span class="ot">&lt;-</span> <span class="cf">function</span>(o) <span class="fu">return</span>(o<span class="sc">/</span>(<span class="dv">1</span><span class="sc">+</span>o))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Probability of Bob having Covid is:"</span>,<span class="fu">round</span>(<span class="fu">odds_to_prob</span>(<span class="fl">0.1</span>),<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## Probability of Bob having Covid is: 0.09</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Probability of Alice having Covid is:"</span>,<span class="fu">round</span>(<span class="fu">odds_to_prob</span>(<span class="fl">3.3</span>),<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## Probability of Alice having Covid is: 0.77</code></pre>
<p>Just as the medical test paradox sheds light on common misinterpretations of probability, the Prosecutorâ€™s Fallacy illustrates these challenges in a legal context, further emphasizing the need for probabilistic thinking in AML.</p>
</section>
</section>
<section id="the-prosecutors-fallacy" class="level2">
<h2 class="anchored" data-anchor-id="the-prosecutors-fallacy">The Prosecutorâ€™s Fallacy</h2>
<p>It is not just doctors, but also lawyers, juries and judges who have sometimes failed to interpret probabilities correctly.</p>
<p>In the 1968 case, People vs Collins , Malcolm and Janet Collins, an interracial couple, were arrested for robbery as their characteristics matched those given by an eye witness.</p>
<p>The prosecution made the argument that the chances of the couple just happening to be at the crime scene by pure chance was extremely low.</p>
<p>The probability of observing each of the coupleâ€™s characteristics were given as follows.</p>
<table class="caption-top table">
<caption>Table 1: Probability of seeing a match with characteristics seen by Eye witness</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Observation</th>
<th style="text-align: left;">Probability</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Man with mustache</td>
<td style="text-align: left;">1/4</td>
</tr>
<tr class="even">
<td style="text-align: left;">Woman with blonde hair</td>
<td style="text-align: left;">1/3</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Woman with pony tail</td>
<td style="text-align: left;">1/10</td>
</tr>
<tr class="even">
<td style="text-align: left;">African American man with beard</td>
<td style="text-align: left;">1/10</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Interracial couple in a car</td>
<td style="text-align: left;">1/1000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Partly yellow car</td>
<td style="text-align: left;">1/10</td>
</tr>
</tbody>
</table>
<p>Consider the hypothesis (H) that the couple is innocent. Under this hypothesis, the probability (D) that an eyewitness would see a couple with the specified characteristics is astonishingly low, calculated as 1 in 12 millionâ€”a product of the individual probabilities detailed above. Note this assumes these characteristics are independent which is almost certainly not true and actually underestimates the probability.</p>
<p>The couple were initially convicted based on this argument.If the likelihood of them being innocent is so small, then they ought to be guilty.</p>
<p>The problem is that this probability gives the probability of observing a couple with the given characteristics under the hypothesis that the couple were innocent.</p>
<p>This is P(D|H), the <strong>sampling probability</strong>.</p>
<p>However, what we are really interested in is the probability that the hypothesis is true given we observed a couple with the aforementioned characteristics - P(H|D) or the inferential probability.</p>
<p>This can again be calculated using Bayes rule as follows</p>
<p><span class="math display">\[ P(H \mid D) =  \frac {P(D\mid H) \times P(H)}{P(D)}  \]</span> where</p>
<p><span class="math display">\[ P(D) = P( D \mid H) \times P(H) + P( D \mid \neg H) \times P( \neg H) \]</span></p>
<p>Now we have to determine priors - <span class="math inline">\(P(H)\)</span> , the prior probability that the couple is innocent and <span class="math inline">\(P( \neg H)\)</span> , the prior probability that the couple is guilty. Note these are to determined before we observe any evidence i.e.&nbsp;the eye witness account.</p>
<p>Given there were some 5 million couples in the Los Angeles area where the crime was committed, and any one of these couples could have committed a crime, a reasonable prior is</p>
<p><span class="math display">\[ P(\neg H) = \frac{1}{5,000,000}  \]</span></p>
<p>This implies</p>
<p><span class="math display">\[ P(H) = \frac{4,999,999}{5,000,000}\]</span></p>
<p>The other term we need to determine is <span class="math inline">\(P(\frac{D}{\neg H})\)</span>, This is the probability of observing the stated characteristics in table 1, if the couple were guilty. This will be <strong>1</strong>.</p>
<p>Plugging these values in, the posterior probability that the couple is innocent is given by</p>
<p><span class="math display">\[ P(H \mid D) =  \frac {\frac{1}{12,000,000} \times \frac{4,999,999}{5,000,000}}{ \frac{1}{12,000,000} \times \frac{4,999,999}{5,000,000} + 1 \times \frac{1}{5,000,000}} = 0.294 \]</span></p>
<p>The posterior probability hat the couple is innocent is actually close to 30% rather 1 in 12,000,000. This certainly does not prove anything beyond a reasonable doubt.</p>
<p>You will be glad to know the Collinsesâ€™ were acquitted by the California Supreme Court on appeal where the presiding judge commented :</p>
<blockquote class="blockquote">
<p>Undoubtedly the jurors were unduly impressed by the mystique of the mathematical demonstration but were unable to assess its relevancy or value</p>
</blockquote>
</section>
<section id="why-this-matters-in-aml" class="level2">
<h2 class="anchored" data-anchor-id="why-this-matters-in-aml">Why this matters in AML</h2>
<p>My contention is that AML practitioners also fall victim to base rate fallacy. In place of intervening medically when not needed, or convicting innocent people, AML practitioners tend to investigate cases or file SARs when there isnâ€™t compelling evidence to do so.</p>
<p>Much like in the case against the Collinses, we tend to make decisions based on sampling probabilities rather than inferential probabilities. The chances of all these models triggering an alert on a regular customer is really low, so if they do alert, the customer must be worth investigating.</p>
<p>Consider how transaction monitoring is typically done at most institutions. The transaction activity of a customer is monitored for patterns like Change in Behavior or Rapid Movement or Rapid Flow Through of Funds. If a customer triggers alerts on some combination of these scenarios, a case is created.</p>
<p>Some institutions are so conservative that a case is created if an alert is triggered for just one of these scenarios. For others, a case is created only if some combination of these scenarios triggers an alert.</p>
<p>Let us assume under regime 1. we create and investigate a case when any one of these scenarios triggers an alert. Under regime 2 on the other hand, we create a case only when all three scenarios trigger an alert.</p>
<p>Now each of these scenarios are equivalent to a medical test. When a medical test returns a positive result, a physician can choose to intervene. Similarly, when a scenario triggers an alert, an investigator can choose to intervene and investigate the customer. The key question is how much evidence is sufficient to justify this intervention.</p>
<p>Let us assume both institutions use three different scenarios or models - Scenario A (Change in Behavior) ,Scenario B (Rapid Flow Through of Funds) , Scenario C (High Risk CounterParty), with the goal of detecting Shell Accounts that might be operating through the institution.</p>
<p>The hypothesis here is that a shell company will demonstrate these underlying patterns.</p>
<p>I will also assume the scenarios alert independent of each other and make the following assumptions for each scenario.</p>
<p>Probability of a customer showing target pattern given customer is a shell company = 0.99 <br> Probability of a customer showing target pattern given customer is not a shell company = 0.01 <br> Probability a scenario alerts in the presence of the pattern = 0.9 <br> Probability a scenario alerts in the absence of the target pattern: 0.05</p>
<p>For each of the models, the performance of the scenario is as follows</p>
<p>Sensitivity<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> is 0.8915 (0.9 x 0.99 + 0.05x(1 - 0.99)). If the customer is truly a criminal, this is the probability that a model triggers and an alert.</p>
<p>Specificity<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> is 0.9415 (1 - 0.9 x 0.01 + 0.05*(1-0.01)). If the customer is a regular citizen, this is the probability that the model does not alert.</p>
<table class="caption-top table">
<caption>Table 2: Accuracy of scenarios</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Scenario</th>
<th style="text-align: right;">Sensitivity</th>
<th style="text-align: right;">Specificity</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Scenario A</td>
<td style="text-align: right;">0.8915</td>
<td style="text-align: right;">0.9415</td>
</tr>
<tr class="even">
<td style="text-align: left;">Scenario B</td>
<td style="text-align: right;">0.8915</td>
<td style="text-align: right;">0.9415</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Scenario C</td>
<td style="text-align: right;">0.8915</td>
<td style="text-align: right;">0.9415</td>
</tr>
</tbody>
</table>
<p>Note this is the performance you would see only with a high quality scenario.</p>
<p>Now,a critical question. What is the prior probability that a customer at either Financial Institution (FI) is a bad actor or criminal.</p>
<p>Let us assume FI 1 is a regional bank in the US mid west. Here the prior probability of any given customer being a money launderer is very small. Say 1/1,000,000.</p>
<p>Let us assume FI 2 is an international bank offering services in tax havens and high risk jurisdictions, here the prior would be an order of magnitude bigger. Say 1/100,000</p>
<section id="fi-1-under-regime-1" class="level3">
<h3 class="anchored" data-anchor-id="fi-1-under-regime-1">FI 1 under regime 1</h3>
<p>Here, we have an FI with a low risk customer base which also has a very conservative approach to reviewing cases.</p>
<p>The posterior probability of an alerted customer being truly suspicious is truly minuscule.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Prior odds x Bayes factor for one scenario</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">odds_to_prob</span>(<span class="fu">prob_to_odds</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">1000000</span>)<span class="sc">*</span> <span class="fu">bf</span>(<span class="fl">0.8915</span>,<span class="fl">0.9415</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## [1] 1.52391e-05</code></pre>
</section>
<section id="fi-2-under-regime-1" class="level3">
<h3 class="anchored" data-anchor-id="fi-2-under-regime-1">FI 2 under regime 1</h3>
<p>What about the FI with a higher risk customer base ?</p>
<p>Even here, a conservative approach to investigating cases leads to an extremely low posterior probability of a case being truly effective, albeit three orders of magnitude higher than for FI 1.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Prior odds x Bayes factor for one scenario</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">odds_to_prob</span>(<span class="fu">prob_to_odds</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">1000</span>)<span class="sc">*</span> <span class="fu">bf</span>(<span class="fl">0.8915</span>,<span class="fl">0.9415</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## [1] 0.01502537</code></pre>
</section>
<section id="fi-1-under-regime-2" class="level3">
<h3 class="anchored" data-anchor-id="fi-1-under-regime-2">FI 1 under regime 2</h3>
<p>What about FI 1 with a less conservative approach to creating cases ? It gets only marginally better.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Prior odds x Bayes Factor for three independent scenarios</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">odds_to_prob</span>(<span class="fu">prob_to_odds</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">1000000</span>)<span class="sc">*</span> <span class="fu">bf</span>(<span class="fl">0.8915</span>,<span class="fl">0.9415</span>)<span class="sc">^</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## [1] 0.003526652</code></pre>
</section>
<section id="fi-2-under-regime-2" class="level3">
<h3 class="anchored" data-anchor-id="fi-2-under-regime-2">FI 2 under regime 2</h3>
<p>What about FI 2 with a less conservative approach to creating cases ?</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Prior odds x Bayes Factor for three independent scenarios</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">odds_to_prob</span>(<span class="fu">prob_to_odds</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">1000</span>)<span class="sc">*</span> <span class="fu">bf</span>(<span class="fl">0.8915</span>,<span class="fl">0.9415</span>)<span class="sc">^</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## [1] 0.7798652</code></pre>
<p>Only in this case does, even such a set of high quality scenarios yields cases that are truly likely to result in a SAR.</p>
</section>
</section>
<section id="takeaways" class="level2">
<h2 class="anchored" data-anchor-id="takeaways">Takeaways</h2>
<p>Here is what I think we should do differently to improve the efficiency of AML Detection programs.</p>
<ol type="1">
<li><p>Instead of creating cases based on binary rules or models, models or rules should output probabilities that represent the posterior probability of a case being truly effective.</p>
<p>Institutions can then choose to review cases only when the posterior probability is greater than some threshold which they can choose based on their risk tolerance. If they choose to review cases with a very low posterior probability as FI 1 chooses to do, then they should expect a lot of false positives.</p>
<p>Alternately,institutions can wait until more evidence accumulates before investigating a case. This can lead to creation of higher quality cases</p></li>
<li><p>Create better segmentation. A good risk based segmentation system can create segments where the prior probability is much higher which in turn can lead to higher quality cases.</p></li>
<li><p>Create better features. This is a no brainer. Features that can more accurately detect the underlying patterns of interest will lead to improved detection. Deriving features from graph representations of underlying transaction data or time series data are promising avenues to consider.</p></li>
<li><p>Assign importance to alerts based on how discriminating the underlying patterns are. If a scenario monitors for highly generic patterns that can manifest for both regular customers and bad actors, alerts will be very noisy by design. The weight given to alerts from such scenarios should be low given how noisy they can be.</p></li>
<li><p>Create richer cases by collecting as many signals as you can. Transaction data can only tell you so much. Incorporate signals from external data sources such as negative news stories or ICIJ data sets to improve the quality of cases.</p></li>
</ol>
</section>
<section id="references-and-resources" class="level2">
<h2 class="anchored" data-anchor-id="references-and-resources">References and Resources</h2>
<ol type="1">
<li><a href="https://www.amazon.com/Bernoullis-Fallacy-Statistical-Illogic-Science/dp/0231199945">Bernoulliâ€™s Fallacy: Statistical Illogic and the Crisis of Modern Science</a> <br></li>
</ol>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>https://www.youtube.com/watch?v=lG4VkPoG3ko<a href="#fnref1" class="footnote-back" role="doc-backlink">â†©ï¸Ž</a></p></li>
<li id="fn2"><p>P(S=Alert | Cust = Criminal) = P(S=Alert |(Cust shows Pattern) x P(Cust Shows Pattern |Cust = Criminal) + P(S =Alert |Cust shows no pattern) x P(Cust shows no pattern | Cust = Criminal)<a href="#fnref2" class="footnote-back" role="doc-backlink">â†©ï¸Ž</a></p></li>
<li id="fn3"><p>1 - P(S=Alert | Cust = Citizen) = 1 - P(S=Alert |(Cust shows Pattern) x P(Cust Shows Pattern |Cust = Citizen) + P(S =Alert |Cust shows no pattern) x P(Cust shows no pattern | Cust = Citizen)<a href="#fnref3" class="footnote-back" role="doc-backlink">â†©ï¸Ž</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>